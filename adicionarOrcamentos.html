<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adicionar Pacientes</title>

    <link rel="stylesheet" href="adicionarOrcamentos.css">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background: #fff;
            z-index: 1000;
        }
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <main id="conteudo_adicionar_orcamento">
        <a class="a-ativo botao_orcamento" id="botao_voltar_a_orcamentos">Orçamentos</a> <a class="a-inativo">/ Adicionar Orçamento</a>
        <div class="container-adicionar-orcamento">
            <div class="div-h3">
                <h3>Novo Orçamento</h3>
            </div>
            <div class="container-adicionar-orcamento-conteudo">
                <div class="container-informacoes">
                    <div class="div-inputs">
                        <div>
                            <label for="paciente">Paciente</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="paciente" placeholder="Digite o nome do paciente">
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fa fa-search" aria-hidden="true"></i></span>
                                </div>
                            </div>
                            <div id="suggestions" class="suggestions"></div>
                        </div>
                    </div>
                    <div class="div-inputs">
                        <input type="date" name="data" id="data">
                    </div>
                </div>
                <div class="div-botoes-acao-adicionar-cancelar">
                    <a class="botao-adicionar" href="#">Adicionar</a>
                    <a class="botao-cancelar botao_orcamento" href="#">Cancelar</a>
                </div>
            </div>
        </div>
    </main>

    <script>
        var idPacientePesquisado;

        $(document).ready(function() {
            $('#paciente').on('keyup', function() {
                var query = $(this).val().toLowerCase();
                $('#suggestions').empty();

                if (query.length > 0) {
                    var filteredPacientes = pacientes.filter(p => p.paciente.toLowerCase().includes(query));

                    filteredPacientes.forEach(paciente => {
                        $('#suggestions').append('<div class="suggestion-item" data-id="' + paciente.id + '">' + paciente.paciente + '</div>');
                    });

                    $('.suggestion-item').on('click', function() {
                        var id = $(this).data('id');
                        idPacientePesquisado = id;
                        var pacienteSelecionado = pacientes.find(p => p.id === id);
                        
                        $('#paciente').val(pacienteSelecionado.paciente);
                        $('#suggestions').empty();
                    });
                }
            });

            var dataAtual = new Date();
            var ano = dataAtual.getFullYear();
            var mes = ('0' + (dataAtual.getMonth() + 1)).slice(-2);
            var dia = ('0' + dataAtual.getDate()).slice(-2);
            var dataFormatada = ano + '-' + mes + '-' + dia;
            $('#data').val(dataFormatada);

            $('.botao-adicionar').on('click', function(e) {
                e.preventDefault();

                var paciente = $('#paciente').val();

                if (paciente.trim() === '') {
                    alert('Por favor, preencha o nome do paciente.');
                } else {
                    // Carregue o conteúdo de fazerOrcamento.html e preencha os campos necessários
                    carregarOrcamento(idPacientePesquisado);
                }
            });
        });

        function carregarOrcamento(id) {
            // Encontrar o paciente pelo ID
            var paciente = pacientes.find(p => p.id === id);

            if (paciente) {
                // Construir a URL do formulário de orçamento
                var url = 'fazerOrcamento.html';

                // Fazer uma requisição AJAX para obter o conteúdo do formulário
                var xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);

                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 400) {
                        // Sucesso na requisição
                        document.querySelector('#conteudo_paginas').innerHTML = xhr.responseText;

                        // Preencher os campos do formulário com os valores do paciente
                        document.getElementById('pacienteNome').value = paciente.paciente;

                        var dataAtual = new Date();
                        var ano = dataAtual.getFullYear();
                        var mes = ('0' + (dataAtual.getMonth() + 1)).slice(-2);
                        var dia = ('0' + dataAtual.getDate()).slice(-2);
                        var dataFormatada = ano + '-' + mes + '-' + dia;
                        document.getElementById('dataOrcamento').value = dataFormatada;
                    } else {
                        // Tratar erros, se necessário
                        console.error('Erro ao carregar formulário de orçamento.');
                    }
                };

                xhr.onerror = function() {
                    // Tratar erros de requisição
                    console.error('Erro ao carregar formulário de orçamento.');
                };

                xhr.send();
            } else {
                alert('Paciente não encontrado.');
            }
        }
    </script>
    <script src="botaoCarregarConteudoSideBar.js"></script>
</body>
</html>
